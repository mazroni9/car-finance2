# دليل ملفات SQL – مشروع car-finance

هذا المجلد يحتوي على ملفات إعداد قاعدة البيانات الخاصة بمنصة `car-finance`.

---

## 📁 محتويات المجلد

| الملف                          | الوصف                                                                 |
|-------------------------------|------------------------------------------------------------------------|
| `schema/unified_schema.sql`   | **الإسكيم الموحد الرئيسي** - يحتوي على جميع الجداول والوظائف المطلوبة |
| `schema/README_UNIFIED_SCHEMA.md` | دليل مفصل للإسكيم الموحد وكيفية تطبيقه |

---

## 🛠️ خطوات التنفيذ

1. **تطبيق الإسكيم الموحد:**
   - اذهب إلى لوحة تحكم Supabase
   - افتح SQL Editor
   - انسخ محتوى `schema/unified_schema.sql`
   - اضغط Run لتنفيذ الإسكيم

2. **التحقق من التطبيق:**
   - تأكد من إنشاء جميع الجداول
   - تحقق من وجود البيانات التجريبية
   - اختبر عمل API `/api/cars`

---

## ✅ ملاحظات مهمة

- **الإسكيم الموحد** يحل جميع التعارضات السابقة في أنواع البيانات
- يحتوي على **بيانات تجريبية** جاهزة للاستخدام
- يتضمن **جميع الوظائف والـ Triggers** المطلوبة
- **محدث ليتناسب مع الكود الحالي** في التطبيق

---

## 🔄 التحديثات المستقبلية

لإضافة تحديثات جديدة:
1. أضف ملفات SQL في مجلد `migrations/`
2. أو قم بتحديث `schema/unified_schema.sql` مباشرة
3. احتفظ بنسخة احتياطية قبل التحديث

---

## 📊 الجداول الرئيسية

### جداول السيارات والمعارض
- `car_showcase` - جدول السيارات الرئيسي
- `users` - جدول المستخدمين
- `customers` - جدول العملاء

### جداول المحافظ والمعاملات
- `wallets` - محافظ المستخدمين
- `wallet_transactions` - معاملات المحافظ
- `dealer_wallets` - محافظ المعارض
- `dealer_transactions` - معاملات المعارض

### جداول التمويل والتقسيط
- `financing_requests` - طلبات التمويل
- `finance_transactions` - العمليات المالية
- `installment_rules` - قواعد التقسيط
- `pricing_rules` - قواعد الأسعار

### جداول المستثمرين والاستثمارات
- `investors` - المستثمرين
- `investment_cycles` - دورات الاستثمار
- `investor_profits` - أرباح المستثمرين

### جداول أخرى
- `subscriptions` - اشتراكات المستخدمين
- `settlements` - التسويات والمدفوعات

---

## 🚀 الدوال المتاحة

- `update_wallet_balance()` - تحديث رصيد المحفظة
- `update_dealer_wallet_balance()` - تحديث رصيد محفظة المعرض
- `link_cars_to_showroom()` - ربط السيارات بمعرض
- `get_financial_summary()` - حساب الملخص المالي

---

## 🔧 استكشاف الأخطاء

إذا واجهت مشاكل:
1. تحقق من متغيرات البيئة في `.env.local`
2. تأكد من تطبيق الإسكيم بنجاح
3. راقب كونسول السيرفر للأخطاء
4. راجع `schema/README_UNIFIED_SCHEMA.md` للتفاصيل

---

**ملاحظة:** هذا الإسكيم الموحد يحل جميع التعارضات السابقة ويضمن عمل المنصة بشكل صحيح.

تم تحديثه في 2025-01-XX